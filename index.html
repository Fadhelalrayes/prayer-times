<script>
/* ====== قاعدة دول/مدن + المنطقة الزمنية ====== */
const CATALOG = [
  { tz:'Asia/Bahrain', cEN:'Bahrain',  cAR:'البحرين', cities:[
    {ar:'المنامة', en:'Manama'}, {ar:'المحرق', en:'Muharraq'}, {ar:'الرفاع', en:'Riffa'}, {ar:'سترة', en:'Sitra'}
  ]},
  { tz:'Asia/Baghdad', cEN:'Iraq',     cAR:'العراق',  cities:[
    {ar:'النجف', en:'Najaf'}, {ar:'كربلاء', en:'Karbala'}, {ar:'الكاظمية', en:'Kadhimiyah'},
    {ar:'بغداد', en:'Baghdad'}, {ar:'البصرة', en:'Basrah'}
  ]},
  { tz:'Asia/Tehran',  cEN:'Iran',     cAR:'إيران',   cities:[
    {ar:'قم', en:'Qom'}, {ar:'مشهد', en:'Mashhad'}, {ar:'طهران', en:'Tehran'}, {ar:'شيراز', en:'Shiraz'}
  ]},
  { tz:'Asia/Beirut',  cEN:'Lebanon',  cAR:'لبنان',   cities:[ {ar:'بيروت', en:'Beirut'}, {ar:'صور', en:'Tyre'} ]},
  { tz:'Asia/Kuwait',  cEN:'Kuwait',   cAR:'الكويت',  cities:[ {ar:'مدينة الكويت', en:'Kuwait City'}, {ar:'الأحمدي', en:'Al Ahmadi'}, {ar:'حولي', en:'Hawalli'} ]},
  { tz:'Asia/Karachi', cEN:'Pakistan', cAR:'باكستان', cities:[ {ar:'إسلام آباد', en:'Islamabad'}, {ar:'كراتشي', en:'Karachi'}, {ar:'لاهور', en:'Lahore'} ]},
  { tz:'Asia/Kabul',   cEN:'Afghanistan', cAR:'أفغانستان', cities:[ {ar:'كابول', en:'Kabul'}, {ar:'هرات', en:'Herat'} ]},
  { tz:'Asia/Riyadh',  cEN:'Saudi Arabia', cAR:'السعودية', cities:[ {ar:'القطيف', en:'Qatif'}, {ar:'الأحساء', en:'Al Ahsa'}, {ar:'المدينة المنورة', en:'Medina'} ]},
  { tz:'Asia/Damascus', cEN:'Syria',   cAR:'سوريا',   cities:[ {ar:'دمشق', en:'Damascus'}, {ar:'السيدة زينب', en:'Sayyidah Zaynab'} ]},
  { tz:'Asia/Aden',    cEN:'Yemen',    cAR:'اليمن',   cities:[ {ar:'صنعاء', en:'Sanaa'}, {ar:'صعدة', en:'Saada'} ]},
  { tz:'Europe/Istanbul', cEN:'Turkey', cAR:'تركيا',  cities:[ {ar:'إسطنبول', en:'Istanbul'}, {ar:'أنقرة', en:'Ankara'} ]},
  { tz:'Europe/London', cEN:'United Kingdom', cAR:'المملكة المتحدة', cities:[ {ar:'لندن', en:'London'} ]},
  { tz:'America/Detroit', cEN:'United States', cAR:'الولايات المتحدة', cities:[ {ar:'ديربورن', en:'Dearborn'}, {ar:'هيوستن', en:'Houston'} ]},
  { tz:'America/Toronto', cEN:'Canada', cAR:'كندا',   cities:[ {ar:'تورونتو', en:'Toronto'}, {ar:'فانكوفر', en:'Vancouver'} ]},
  { tz:'Asia/Baku',     cEN:'Azerbaijan', cAR:'أذربيجان', cities:[ {ar:'باكو', en:'Baku'}, {ar:'نارداران', en:'Nardaran'} ]},
];

/* ===== عناصر DOM ===== */
const el = {
  country: document.getElementById('country'),
  city: document.getElementById('city'),
  date: document.getElementById('datePicker'),
  prev: document.getElementById('prev'),
  next: document.getElementById('next'),
  show: document.getElementById('show'),
  tbody: document.getElementById('tbody'),
  status: document.getElementById('status'),
  fontPicker: document.getElementById('fontPicker'),
  cityManual: document.getElementById('cityManual'),
  countryManual: document.getElementById('countryManual'),
  useManual: document.getElementById('useManual')
};

/* ===== أدوات ===== */
const todayISO = () => new Date().toISOString().split('T')[0];
const toDMY = (iso) => { const [y,m,d] = iso.split('-'); return `${d}-${m}-${y}`; };
const to12h = (s) => { const m = String(s).match(/(\d{1,2}):(\d{2})/); if(!m) return s; let h=+m[1], M=m[2]; const suf=h>=12?'م':'ص'; h=h%12||12; return `${h}:${M} ${suf}`; };
const setStatus = (s) => el.status.textContent = s;

/* ===== تعبئة القوائم مع افتراضي البحرين ===== */
function fillCountries(defaultEN='Bahrain'){
  el.country.innerHTML = CATALOG
    .slice().sort((a,b)=>a.cAR.localeCompare(b.cAR,'ar'))
    .map(d=>`<option value="${d.cEN}">${d.cAR}</option>`).join('');
  el.country.dataset.tz = CATALOG.find(x=>x.cEN===defaultEN)?.tz || 'Asia/Bahrain';
  el.country.value = defaultEN;
}
function fillCities(){
  const d = CATALOG.find(x=>x.cEN===el.country.value);
  el.country.dataset.tz = d?.tz || '';
  el.city.innerHTML = (d?.cities||[]).map(c=>`<option value="${c.en}">${c.ar}</option>`).join('');
}

/* ===== رسم ===== */
function draw(t){
  const rows = [
    ['الإمساك', t.Imsak], ['الفجر', t.Fajr], ['الشروق', t.Sunrise],
    ['صلاة الظهر', t.Dhuhr], ['الغروب', t.Sunset], ['صلاة المغرب', t.Maghrib], ['منتصف الليل', t.Midnight]
  ];
  el.tbody.innerHTML = rows.map(r=>`<tr><td>${r[0]}</td><td>${to12h(r[1])}</td></tr>`).join('');
}

/* ===== جلب المواقيت مع منطقة زمنية صريحة ===== */
async function loadTimes({forceManual=false}={}){
  const manual = forceManual || (el.cityManual.value.trim() && el.countryManual.value.trim());
  const city = manual ? el.cityManual.value.trim() : el.city.value;
  const country = manual ? el.countryManual.value.trim() : el.country.value;
  const tz = manual ? '' : (el.country.dataset.tz || '');
  const dateISO = el.date.value || todayISO();
  const dateDMY = toDMY(dateISO);

  if(!city || !country){ setStatus('اختر الدولة والمدينة أو اكتبها يدويًا.'); return; }

  setStatus(`جارِ الجلب لـ ${city}, ${country} — ${dateISO} ...`);
  try{
    const tzParam = tz ? `&timezonestring=${encodeURIComponent(tz)}` : '';
    const url = `https://api.aladhan.com/v1/timingsByCity/${dateDMY}?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}&method=0&iso8601=true${tzParam}`;
    const res = await fetch(url, {cache:'no-store'});
    const js = await res.json();
    if(js.code !== 200 || !js.data?.timings) throw new Error(js.data?.error || 'API error');
    draw(js.data.timings);
    setStatus(`تم التحديث: ${city}, ${country} — ${dateISO}`);
  }catch(e){
    console.error(e);
    setStatus('تعذر جلب المواقيت. جرّب مدينة/دولة أخرى أو استخدم الإدخال اليدوي.');
  }
}

/* ===== أحداث ===== */
el.country.addEventListener('change', ()=>{ fillCities(); loadTimes(); });
el.city.addEventListener('change', ()=>loadTimes());
el.date.addEventListener('change', ()=>loadTimes());
el.prev.addEventListener('click', ()=>{ const d=new Date(el.date.value||todayISO()); d.setDate(d.getDate()-1); el.date.value=d.toISOString().split('T')[0]; loadTimes(); });
el.next.addEventListener('click', ()=>{ const d=new Date(el.date.value||todayISO()); d.setDate(d.getDate()+1); el.date.value=d.toISOString().split('T')[0]; loadTimes(); });
if(el.show) el.show.addEventListener('click', ()=>loadTimes());
if(el.useManual) el.useManual.addEventListener('click', ()=>loadTimes({forceManual:true}));

/* تبديل السمات/الخط (لو موجودة عناصرها) */
document.querySelectorAll('[data-set-theme]').forEach(btn=>{
  btn.addEventListener('click', ()=>{ document.documentElement.setAttribute('data-theme', btn.dataset.setTheme); });
});
if(document.getElementById('fontPicker')){
  document.getElementById('fontPicker').addEventListener('change', (e)=>{
    document.documentElement.style.setProperty('--font', `"${e.target.value}", "Segoe UI", Tahoma, Arial`);
  });
}

/* ===== بدء التشغيل: البحرين افتراضيًا ===== */
(function init(){
  el.date.value = todayISO();
  fillCountries('Bahrain'); // البحرين
  fillCities();             // مدن البحرين
  if(!el.city.value) el.city.innerHTML = `<option value="Manama">المنامة</option>`;
  loadTimes();
})();
</script>
