<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>مواقيت الصلاة وفق المذهب الجعفري</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1420; --panel:#151c2a; --panel2:#1c2435; --txt:#f6f7fb; --muted:#aab3c5; --acc:#ffd369;
    --radius:14px; --font:"Tajawal","Segoe UI",Tahoma,Arial;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(135deg,var(--bg),#0b1020 45%,var(--bg));color:var(--txt);font-family:var(--font)}
  header{position:sticky;top:0;background:#0d1220;border-bottom:1px solid #25324a;padding:14px 10px;text-align:center;z-index:5}
  header h1{margin:0 0 4px;color:var(--acc);font-size:20px}
  header .by{color:var(--muted);font-size:12px}
  .wrap{max-width:820px;margin:16px auto;padding:12px}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #2a3959;border-radius:var(--radius);box-shadow:0 8px 22px rgba(0,0,0,.35);padding:14px}
  .controls{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
  @media (max-width:780px){ .controls{grid-template-columns:1fr 1fr;} }
  @media (max-width:460px){ .controls{grid-template-columns:1fr;} }
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  select,input[type="date"],button{
    width:100%;background:#0f172a;color:var(--txt);
    border:1px solid #2a3959;border-radius:10px;padding:10px;font-size:14px;outline:none
  }
  select:focus,input[type="date"]:focus{border-color:var(--acc)}
  .btn{cursor:pointer;background:#101b30;border-color:#375a9e;font-weight:700}
  .btn-ghost{background:transparent;border-color:#3c4b63}
  .status{margin:10px 2px 0;color:var(--muted);font-size:12px;text-align:center;min-height:18px}
  .now{margin:8px 2px 0;color:#d7e3ff;text-align:center;font-weight:700}
  .opts{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:6px;color:var(--muted);font-size:13px}
  .switch{display:inline-flex;align-items:center;gap:8px;cursor:pointer}
  .switch input{accent-color:#3eb489;transform:scale(1.2)}
  table{width:100%;border-collapse:collapse;margin-top:12px;border-radius:12px;overflow:hidden}
  th,td{padding:14px 10px;border-bottom:1px solid #2a3959}
  th{background:#0f1626;color:var(--acc);font-size:14px}
  tbody tr:nth-child(odd){background:#171f2e}
  .time{font-weight:700;font-size:16px}
  .chip{
    display:inline-block; margin-inline-start:8px; padding:2px 8px; border-radius:999px;
    font-size:12px; background:#0f172a; border:1px solid #3a596f; color:#bfe7ff; white-space:nowrap;
  }
  footer{max-width:820px;margin:18px auto;color:var(--muted);font-size:12px;text-align:center;border-top:1px dashed #334;padding:8px}
</style>
</head>
<body>
<header>
  <h1>مواقيت الصلاة وفق المذهب الجعفري</h1>
  <div class="by">إعداد وبرمجة: فاضل الريس</div>
</header>

<div class="wrap">
  <div class="card">
    <div class="controls">
      <div>
        <label>الدولة</label>
        <select id="country"></select>
      </div>
      <div>
        <label>المدينة</label>
        <select id="city"></select>
      </div>
      <div>
        <label>التاريخ</label>
        <input type="date" id="datePicker">
      </div>
      <div style="display:flex; gap:8px; align-items:end">
        <button id="prev" class="btn-ghost" title="اليوم السابق">◀</button>
        <button id="next" class="btn-ghost" title="اليوم التالي">▶</button>
        <button id="show" class="btn" style="flex:1">تحديث</button>
      </div>
    </div>

    <div id="now" class="now">الوقت الآن —</div>
    <div class="opts">
      <label class="switch">
        <input type="checkbox" id="enableAdhan">
        <span>تشغيل الأذان عند حلول الوقت</span>
      </label>
    </div>

    <div class="status" id="status">جاهز</div>

    <table>
      <thead><tr><th>الوقت</th><th style="text-align:center">الساعة</th></tr></thead>
      <tbody id="tbody">
        <tr data-key="Imsak"><td>الإمساك</td><td class="time">—</td></tr>
        <tr data-key="Fajr"><td>الفجر</td><td class="time">—</td></tr>
        <tr data-key="Sunrise"><td>الشروق</td><td class="time">—</td></tr>
        <tr data-key="Dhuhr"><td>صلاة الظهر</td><td class="time">—</td></tr>
        <tr data-key="Sunset"><td>الغروب</td><td class="time">—</td></tr>
        <tr data-key="Maghrib"><td>صلاة المغرب</td><td class="time">—</td></tr>
        <tr data-key="Midnight"><td>منتصف الليل</td><td class="time">—</td></tr>
      </tbody>
      <tfoot><tr><td colspan="2" id="foot">—</td></tr></tfoot>
    </table>
  </div>
</div>

<footer>جميع الحقوق محفوظة © 2025</footer>

<!-- ملف الأذان: ارفع ملف باسم adhan.mp3 في جذر المستودع أو بدّل المسار هنا -->
<audio id="adhanAudio" src="adhan.mp3" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script>
/* ——— الدول/المدن + المنطقة الزمنية ——— */
const CATALOG = [
  { tz:'Asia/Bahrain', cEN:'Bahrain',  cAR:'البحرين',  cities:[{ar:'المنامة',en:'Manama'},{ar:'المحرق',en:'Muharraq'},{ar:'الرفاع',en:'Riffa'},{ar:'سترة',en:'Sitra'}]},
  { tz:'Asia/Kuwait',  cEN:'Kuwait',   cAR:'الكويت',   cities:[{ar:'مدينة الكويت',en:'Kuwait City'},{ar:'الأحمدي',en:'Al Ahmadi'},{ar:'حولي',en:'Hawalli'}]},
  { tz:'Asia/Baghdad', cEN:'Iraq',     cAR:'العراق',   cities:[{ar:'النجف',en:'Najaf'},{ar:'كربلاء',en:'Karbala'},{ar:'بغداد',en:'Baghdad'}]},
  { tz:'Asia/Tehran',  cEN:'Iran',     cAR:'إيران',    cities:[{ar:'قم',en:'Qom'},{ar:'مشهد',en:'Mashhad'},{ar:'طهران',en:'Tehran'}]},
  { tz:'Asia/Beirut',  cEN:'Lebanon',  cAR:'لبنان',    cities:[{ar:'بيروت',en:'Beirut'},{ar:'صور',en:'Tyre'}]},
  { tz:'Asia/Karachi', cEN:'Pakistan', cAR:'باكستان',  cities:[{ar:'إسلام آباد',en:'Islamabad'},{ar:'كراتشي',en:'Karachi'}]},
  { tz:'Asia/Riyadh',  cEN:'Saudi Arabia', cAR:'السعودية', cities:[{ar:'القطيف',en:'Qatif'},{ar:'الأحساء',en:'Al Ahsa'}]},
];

const el = {
  country: document.getElementById('country'),
  city: document.getElementById('city'),
  date: document.getElementById('datePicker'),
  prev: document.getElementById('prev'),
  next: document.getElementById('next'),
  show: document.getElementById('show'),
  status: document.getElementById('status'),
  tbody: document.getElementById('tbody'),
  foot: document.getElementById('foot'),
  now: document.getElementById('now'),
  enableAdhan: document.getElementById('enableAdhan'),
  adhanAudio: document.getElementById('adhanAudio')
};
const { DateTime } = luxon;
let timer = null;       // عداد الشارة
let clockTimer = null;  // ساعة الآن

/* ——— أدوات ——— */
const todayISO = () => DateTime.now().toISODate();
const toDMY = iso => { const [y,m,d]=iso.split('-'); return `${d}-${m}-${y}`; };

function formatTime(val, zone){
  if(!val) return '—';
  if (String(val).includes('T')){
    const dt = DateTime.fromISO(val, {zone});
    if (dt.isValid) return dt.toFormat('h:mm a').replace('AM','ص').replace('PM','م');
  }
  const [hStr,m] = String(val).split(':');
  let h = parseInt(hStr,10);
  const suf = h>=12?'م':'ص';
  h = h%12 || 12;
  return `${h}:${String(m||'00').padStart(2,'0')} ${suf}`;
}

function timeToDT(val, zone, baseISO){
  if (String(val).includes('T')) return DateTime.fromISO(val, {zone});
  const [h,m] = String(val).split(':').map(Number);
  return DateTime.fromISO(baseISO, {zone}).set({hour:h, minute:m, second:0, millisecond:0});
}

/* ——— ساعة "الوقت الآن" ——— */
function startNowClock(zone){
  if (clockTimer) { clearInterval(clockTimer); clockTimer = null; }
  function tick(){
    const n = DateTime.now().setZone(zone);
    el.now.textContent = `الوقت الآن: ${n.toFormat('HH:mm:ss')}`;
  }
  tick(); clockTimer = setInterval(tick, 1000);
}

/* ——— تعبئة ——— */
function fillCountries(def='Bahrain'){
  el.country.innerHTML = CATALOG.map(d=>`<option value="${d.cEN}" data-tz="${d.tz}">${d.cAR}</option>`).join('');
  el.country.value = def;
}
function fillCities(){
  const d = CATALOG.find(x=>x.cEN===el.country.value);
  el.city.innerHTML = (d?.cities||[]).map(c=>`<option value="${c.en}">${c.ar}</option>`).join('');
}
const tz = () => el.country.options[el.country.selectedIndex].dataset.tz || 'UTC';

/* ——— رسم الجدول ——— */
function drawTable(t, zone){
  ['Imsak','Fajr','Sunrise','Dhuhr','Sunset','Maghrib','Midnight'].forEach(k=>{
    const tr = el.tbody.querySelector(`tr[data-key="${k}"]`);
    const td = tr.querySelector('.time');
    td.textContent = formatTime(t[k], zone);
    const old = tr.querySelector('.chip'); if(old) old.remove();
  });
}

/* ——— شارة العدّاد + تشغيل الأذان عند حلول الوقت ——— */
function startChip(timings, zone, iso){
  if (timer){ clearInterval(timer); timer = null; }
  const order = [
    {key:'Fajr',label:'الفجر'},
    {key:'Dhuhr',label:'الظهر'},
    {key:'Maghrib',label:'المغرب'}
  ];
  const list = order.map(p=>({key:p.key, label:p.label, dt:timeToDT(timings[p.key], zone, iso)}))
                    .filter(x=>x.dt.isValid);

  el.tbody.querySelectorAll('.chip').forEach(c=>c.remove());
  const now = DateTime.now().setZone(zone);
  let next = list.find(x=>x.dt > now);
  if(!next) return;

  const target = el.tbody.querySelector(`tr[data-key="${next.key}"] .time`);
  const chip = document.createElement('span'); chip.className='chip'; target.insertAdjacentElement('afterend', chip);

  function tick(){
    const n = DateTime.now().setZone(zone);
    if(n >= next.dt){
      chip.textContent='حان الآن';
      if (el.enableAdhan.checked){
        // محاولة تشغيل الأذان (يتطلب تفعيل المستخدم)
        el.adhanAudio.currentTime = 0;
        el.adhanAudio.play().catch(()=>{ /* قد يمنع المتصفح التشغيل التلقائي */ });
      }
      clearInterval(timer); return;
    }
    const {hours,minutes,seconds} = next.dt.diff(n,['hours','minutes','seconds']).toObject();
    const H = String(Math.floor(hours||0)).padStart(2,'0');
    const M = String(Math.floor(minutes||0)).padStart(2,'0');
    const S = String(Math.floor(seconds||0)).padStart(2,'0');
    chip.textContent = `متبقي ${H}:${M}:${S}`;
  }
  tick(); timer = setInterval(tick, 1000);
}

/* ——— الجلب من Aladhan ——— */
async function loadTimes(){
  const country = el.country.value;
  const city    = el.city.value;
  const zone    = tz();
  const iso     = el.date.value || todayISO();
  const dmy     = toDMY(iso);

  el.status.textContent = `جارِ التحديث لـ ${city}, ${country} — ${iso} ...`;
  try{
    const url = `https://api.aladhan.com/v1/timingsByCity/${dmy}?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}&method=0&iso8601=true&timezonestring=${encodeURIComponent(zone)}`;
    const r = await fetch(url, {cache:'no-store'}); const j = await r.json();
    if (j.code !== 200 || !j.data?.timings) throw new Error('API error');

    drawTable(j.data.timings, zone);
    startChip(j.data.timings, zone, iso);
    startNowClock(zone);

    el.status.textContent = `تم التحديث: ${city}, ${country} — ${iso}`;
    el.foot.textContent   = `طريقة الحساب: الجعفري (Aladhan method=0) — المنطقة الزمنية: ${zone}`;
  }catch(e){
    console.error(e);
    el.status.textContent='تعذر الجلب. جرّب لاحقًا.';
    if (timer){ clearInterval(timer); timer=null; }
  }
}

/* ——— أحداث ——— */
el.country.addEventListener('change', ()=>{ fillCities(); loadTimes(); });
el.city.addEventListener('change', loadTimes);
el.date.addEventListener('change', loadTimes);
el.prev.addEventListener('click', ()=>{ const d=luxon.DateTime.fromISO(el.date.value||todayISO()); el.date.value=d.minus({days:1}).toISODate(); loadTimes(); });
el.next.addEventListener('click', ()=>{ const d=luxon.DateTime.fromISO(el.date.value||todayISO()); el.date.value=d.plus({days:1}).toISODate(); loadTimes(); });
el.show.addEventListener('click', loadTimes);

/* ——— بدء التشغيل: البحرين/المنامة افتراضيًا ——— */
(function init(){
  fillCountries('Bahrain'); fillCities(); el.city.value='Manama';
  el.date.value = todayISO();
  loadTimes();
})();
</script>
</body>
</html>
